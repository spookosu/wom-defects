<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Wise Old Man Leaderboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&amp;display=swap" rel="stylesheet"/>
<style>
    :root {

      --bg: #f9fafb;
      --card: #ffffff;
      --accent: #2563eb;
      --text: #111827;
      --highlight: #f3f4f6;
      --border: #e5e7eb;
      --tab-active-bg: #e0e7ff;
      --tab-hover-bg: #f3f4f6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      padding: 2rem;
      line-height: 1.6;
    }

    h1 {
      text-align: center;
      margin-bottom: 2rem;
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
    }

    .tabs {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .tab-button {
      background-color: transparent;
      color: var(--text);
      border: none;
      font-weight: 600;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .tab-button:hover {
      background-color: var(--tab-hover-bg);
    }

    .tab-button.active {
      background-color: var(--tab-active-bg);
      color: var(--accent);
    }

    .tab-content {
      background-color: var(--card);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      max-width: 1000px;
      margin: 0 auto;
    }

    .tab-content:not(.active) {
      display: none;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background-color: var(--card);
    }

    th, td {
      padding: 1rem 1.25rem;
      text-align: left;
    }

    th {
      background-color: var(--highlight);
      color: var(--text);
      font-weight: 600;
      border-bottom: 2px solid var(--border);
    }

    td {
      border-bottom: 1px solid var(--border);
    }

    tr:hover {
      background-color: var(--tab-hover-bg);
    }

.rank-entry {
  display: flex;
  align-items: center; /* Changed from flex-start to center */
  gap: 2rem;
  margin-bottom: 2rem;
}

.rank-section {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  background-color: #fff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.rank-section h3 {
  margin-bottom: 1rem;
  font-size: 1.5rem;
  color: var(--accent);
}

.rank-entry img {
  width: 250px;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}

.rank-entry ul {
  list-style: none;
  padding-left: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  justify-content: center;
  height: 100%;
}

.rank-entry li {
  margin: 0.5rem 0;
}


    #player-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #player-modal .modal-content {
      background: white;
      max-width: 600px;
      width: 90%;
      padding: 2rem;
      border-radius: 12px;
      position: relative;
    }

    #player-modal .close-button {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.5rem;
      background: none;
      border: none;
      cursor: pointer;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.75rem;
      }

      .tab-button {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
      }

      th, td {
        padding: 0.75rem;
        font-size: 0.875rem;
      }

      .rank-entry {
        flex-direction: column;
        align-items: flex-start;
      }

      .rank-entry img {
        width: 80%;
      }
    }
  </style>
</head>
<body>
<h1>Test leaderboard</h1>
<div class="tabs" role="tablist">
<button aria-controls="leaderboard-tab" aria-selected="true" class="tab-button active" id="tab-leaderboard" role="tab">Leaderboard</button>
<button aria-controls="rankstructure-tab" aria-selected="false" class="tab-button" id="tab-rankstructure" role="tab">Rank Structure</button>
</div>
<section aria-labelledby="tab-leaderboard" class="tab-content active" id="leaderboard-tab" role="tabpanel">
<div class="table-container">
<table id="leaderboard">
<thead>
<tr>
<th>Rank</th>
<th>Player</th>
<th>Total Points</th>
<th>Competitions</th>
</tr>
</thead>
<tbody>
<tr><td colspan="4" style="text-align:center;">Loading leaderboard...</td></tr>
</tbody>
</table>
</div>
</section>
<section aria-labelledby="tab-rankstructure" class="tab-content" id="rankstructure-tab" role="tabpanel" tabindex="0">

<h2>Clan Ranks</h2>
<section class="rank-section">
<h3>Bronze Rank</h3>
<div class="rank-entry">
<img alt="Bronze Rank" src="DeFEcts_Ranks_BRONZE.png"/>
<ul>
<li><label><input type="checkbox"/> Joined the clan</label></li>
</ul>
<ul>
<li style="font-weight:bold;">Optional (counts as 1 total):</li>
<li><label><input data-optional-group="bronze-extra" type="checkbox"/> Optional A</label></li>
<li><label><input data-optional-group="bronze-extra" type="checkbox"/> Optional B</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Iron Rank</h3>
<div class="rank-entry">
<img alt="Iron Rank" src="DeFEcts_Ranks_IRON.png"/>
<ul>
<li><label><input type="checkbox"/> 1100 total level</label></li>
<li><label><input type="checkbox"/> Overhead prayers</label></li>
<li><label><input type="checkbox"/> 38 Herblore</label></li>
<li><label><input type="checkbox"/> Bone Voyage</label></li>
<li><label><input type="checkbox"/> Proselyte Armour</label></li>
<li><label><input type="checkbox"/> Iban's staff (u)/ Warped Sceptre</label></li>
<li><label><input type="checkbox"/> 8/12 Easy Achievement Diaries</label></li>
<li><label><input type="checkbox"/> Fairy rings</label></li>
</ul>
<ul>
<li style="font-weight:bold;">Optional (counts as 1 total):</li>
<li><label><input data-optional-group="iron-choice" type="checkbox"/> Optional Iron A</label></li>
<li><label><input data-optional-group="iron-choice" type="checkbox"/> Optional Iron B</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Steel Rank</h3>
<div class="rank-entry">
<img alt="Steel Rank" src="DeFEcts_Ranks_Steel.png"/>
<ul>
<li><label><input type="checkbox"/> 1250 total level</label></li>
<li><label><input type="checkbox"/> Full Rogue's Outfit</label></li>
<li><label><input type="checkbox"/> Barrows tank top &amp; bottom</label></li>
<li><label><input type="checkbox"/> Helm of Neitiznot</label></li>
<li><label><input type="checkbox"/> Dragon scimitar</label></li>
<li><label><input type="checkbox"/> Rune platebody &amp; antidragon shield</label></li>
<li><label><input type="checkbox"/> Mage Cape</label></li>
<li><label><input type="checkbox"/> Ava's accumulator</label></li>
<li><label><input type="checkbox"/> Climbing boots</label></li>
</ul>
<ul>
<li style="font-weight:bold;">Optional (counts as 1 total):</li>
<li><label><input data-optional-group="steel-choice" type="checkbox"/> Optional Steel A</label></li>
<li><label><input data-optional-group="steel-choice" type="checkbox"/> Optional Steel B</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Mithril Rank</h3>
<div class="rank-entry">
<img alt="Mithril Rank" src="DeFEcts_Ranks_MITHRIL.png"/>
<ul>
<li><label><input type="checkbox"/> 1500 total level</label></li>
<li><label><input type="checkbox"/> 65 fishing</label></li>
<li><label><input type="checkbox"/> Fire cape</label></li>
<li><label><input type="checkbox"/> Piety</label></li>
<li><label><input type="checkbox"/> Desert Treasure I</label></li>
<li><label><input type="checkbox"/> Dream Mentor</label></li>
<li><label><input type="checkbox"/> Royal Trouble</label></li>
<li><label><input type="checkbox"/> Black mask</label></li>
<li><label><input type="checkbox"/> Barrows gloves</label></li>
<li><label><input type="checkbox"/> Amulet of glory</label></li>
<li><label><input type="checkbox"/> One full moons of peril's set</label></li>
<li><label><input type="checkbox"/> 8/12 Medium Achievement Diaries</label></li>
<li><label><input type="checkbox"/> Easy Combat Tasks</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Addy Rank</h3>
<div class="rank-entry">
<img alt="Addy Rank" src="DeFEcts_Ranks_ADDY.png"/>
<ul>
<li><label><input type="checkbox"/> 1750 total level</label></li>
<li><label><input type="checkbox"/> Mage cape (i)</label></li>
<li><label><input type="checkbox"/> Amulet of fury</label></li>
<li><label><input type="checkbox"/> 1 Synapse</label></li>
<li><label><input type="checkbox"/> Vorkath's head</label></li>
<li><label><input type="checkbox"/> Monkey Madness II</label></li>
<li><label><input type="checkbox"/> Song of the Elves</label></li>
<li><label><input type="checkbox"/> A Kingdom Divided</label></li>
<li><label><input type="checkbox"/> Any two dragon tools</label></li>
<li><label><input type="checkbox"/> Abyssal whip &amp; Trident of the seas</label></li>
<li><label><input type="checkbox"/> Full elite void</label></li>
<li><label><input type="checkbox"/> Royal Titans' prayers</label></li>
<li><label><input type="checkbox"/> Medium Combat Tasks</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Onyx Rank</h3>
<div class="rank-entry">
<img alt="Onyx Rank" src="DeFEcts_Ranks_ONYX.png"/>
<ul>
<li><label><input type="checkbox"/> 2200 total level</label></li>
<li><label><input type="checkbox"/> 2 Desert Treasure II rings</label></li>
<li><label><input type="checkbox"/> Full Masori armour (F)</label></li>
<li><label><input type="checkbox"/> Infernal cape</label></li>
<li><label><input type="checkbox"/> Dizana's quiver</label></li>
<li><label><input type="checkbox"/> 500 TOA kit</label></li>
<li><label><input type="checkbox"/> 1 Mega rare</label></li>
<li><label><input type="checkbox"/> 2 Yama or Torva armour pieces</label></li>
<li><label><input type="checkbox"/> Amulet of rancour</label></li>
<li><label><input type="checkbox"/> Avernic treads</label></li>
<li><label><input type="checkbox"/> Master Combat Tasks</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Rune Rank</h3>
<div class="rank-entry">
<img alt="Rune Rank" src="DeFEcts_Ranks_RUNE.png"/>
<ul>
<li><label><input type="checkbox"/> Example requirement for Rune</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Gilded Rank</h3>
<div class="rank-entry">
<img alt="Gilded Rank" src="DeFEcts_Ranks_GILDED.png"/>
<ul>
<li><label><input type="checkbox"/> Example requirement for Gilded</label></li>
</ul>
</div>
</section>
<section class="rank-section">
<h3>Dragon Rank</h3>
<div class="rank-entry">
<img alt="Dragon Rank" src="DeFEcts_Ranks_DRAGON.png"/>
<ul>
<li><label><input type="checkbox"/> Example requirement for Dragon</label></li>
</ul>
</div>
</section>
</section>
<div id="player-modal">
<div class="modal-content">
<button class="close-button" onclick="closeModal()">×</button>
<h2 id="modal-player-name"></h2>
<div id="modal-content"></div>
</div>
</div>






<script>
const pointsMap = new Map();

    const tabs = document.querySelectorAll('.tab-button');
    const contents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        contents.forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.getAttribute('aria-controls')).classList.add('active');
      });
    });

    const GROUP_ID = 11796;
    const COMPETITIONS_API = `https://api.wiseoldman.net/v2/groups/${GROUP_ID}/competitions?status=finished&limit=50`;

    
    const breakdownMap = new Map();

    async function fetchCompetitions() {
      const response = await fetch(COMPETITIONS_API);
      if (!response.ok) throw new Error('Failed to fetch competitions');
      return await response.json();
    }

    async function fetchCompetitionDetails(id) {
      const response = await fetch(`https://api.wiseoldman.net/v2/competitions/${id}`);
      if (!response.ok) throw new Error(`Failed to fetch competition details for ${id}`);
      return await response.json();
    }

    async function buildLeaderboard() {
  const CACHE_KEY = 'leaderboardCache';
  const CACHE_BREAKDOWN_KEY = 'leaderboardBreakdownCache';
  const CACHE_TIMESTAMP_KEY = 'leaderboardCacheTimestamp';
  const CACHE_DURATION = 60 * 60 * 1000; // 1 hour

  const now = Date.now();
  const cachedData = localStorage.getItem(CACHE_KEY);
  const cachedBreakdown = localStorage.getItem(CACHE_BREAKDOWN_KEY);
  const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);

  const useCache = cachedData && cachedBreakdown && cachedTimestamp && (now - parseInt(cachedTimestamp)) < CACHE_DURATION;

  console.log("Checking cache...");
  if (useCache) {
    console.log("Using cached data.");
    const leaderboard = JSON.parse(cachedData);
    const breakdownObj = JSON.parse(cachedBreakdown);
    Object.entries(breakdownObj).forEach(([name, breakdown]) => {
      breakdownMap.set(name, breakdown);
    });
    console.log('Populating leaderboard with leaderboard:', leaderboard);
    populateLeaderboard(leaderboard);
    return;
  }


console.log("🏁 buildLeaderboard() called");
  document.querySelector("#leaderboard tbody").innerHTML = "<tr><td colspan=\"4\">Attempting to load leaderboard...</td></tr>";
  buildLeaderboard();

  try {
    console.log('Fetching competitions from API...');
    const competitions = await fetchCompetitions();
    if (!competitions.length) {
  console.warn("API returned no competitions.");
  throw new Error("No competitions returned");
}

    
    const breakdownObj = {};

    for (const comp of competitions) {
      const competition = await fetchCompetitionDetails(comp.id);
      const participations = competition.participations || [];
      participations.sort((a, b) => b.progress.gained - a.progress.gained);

      participations.forEach((p, idx) => {
        const name = p.player.displayName || p.player.username;
        if (!name || name.toLowerCase() === 'ekofresh') return;

        const position = idx + 1;
        let rankPoints = [120, 100, 85, 75, 65, 55, 45, 35, 25, 15][idx] || 0;
        const participationPoints = p.progress.gained > 0 ? 5 : 0;
        const points = rankPoints + participationPoints;

        if (!pointsMap.has(name)) pointsMap.set(name, { totalPoints: 0, count: 0 });
        const stats = pointsMap.get(name);
        stats.totalPoints += points;
        if (p.progress.gained > 0) stats.count++;

        if (!breakdownObj[name]) breakdownObj[name] = [];
        breakdownObj[name].push({
          competition: competition.title,
          points,
          rank: position,
          gained: p.progress.gained
        });
      });
    }

    const totals = Array.from(pointsMap.entries()).map(([username, stats]) => ({ username, ...stats }));
    totals.sort((a, b) => b.totalPoints - a.totalPoints);

    // Save to localStorage
    localStorage.setItem(CACHE_KEY, JSON.stringify(totals));
    localStorage.setItem(CACHE_BREAKDOWN_KEY, JSON.stringify(breakdownObj));
    localStorage.setItem(CACHE_TIMESTAMP_KEY, now.toString());

    Object.entries(breakdownObj).forEach(([name, breakdown]) => {
      breakdownMap.set(name, breakdown);
    });

    populateLeaderboard(totals);
  } catch (err) {
    if (cachedData && cachedBreakdown) {
      const leaderboard = JSON.parse(cachedData);
      const breakdownObj = JSON.parse(cachedBreakdown);
      Object.entries(breakdownObj).forEach(([name, breakdown]) => {
        breakdownMap.set(name, breakdown);
      });
      console.log('Populating leaderboard with leaderboard:', leaderboard);
    populateLeaderboard(leaderboard);
      console.error('Fetch error occurred. Using cached data:', err);
    } else {
      document.querySelector('#leaderboard tbody').innerHTML = `<tr><td colspan="4">Error: ${err.message}</td></tr>`;
    }
  }
}

function populateLeaderboard(totals) {
  const tbody = document.querySelector('#leaderboard tbody');
  tbody.innerHTML = '';
  totals.forEach((p, i) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>#${i + 1}</td>
      <td><a href="#" onclick="showBreakdown('${p.username.replace(/'/g, "\'")}')">${p.username}</a></td>
      <td>${p.totalPoints}</td>
      <td>${p.count}</td>
    `;
    tbody.appendChild(row);
  });
}
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const sections = document.querySelectorAll('.rank-section');

    sections.forEach(section => {
      const checkboxes = section.querySelectorAll('input[type="checkbox"]');
      const counter = document.createElement('div');
      counter.style.marginTop = '1rem';
      counter.style.fontWeight = 'bold';
      section.appendChild(counter);

      const updateCounter = () => {
        let checkedCount = 0;
        let baseTotal = 0;
        const optionalGroups = {};

        checkboxes.forEach(cb => {
          const group = cb.dataset.optionalGroup;
          if (group) {
            if (!optionalGroups[group]) optionalGroups[group] = [];
            optionalGroups[group].push(cb);
          } else {
            baseTotal++;
            if (cb.checked) checkedCount++;
          }
        });

        for (const group in optionalGroups) {
          const groupChecks = optionalGroups[group];
          const groupChecked = groupChecks.filter(cb => cb.checked).length;
          if (groupChecked >= 2) {
            checkedCount++; // Count only when at least 2 in a group are checked
          }
        }

        if (checkedCount > baseTotal) checkedCount = baseTotal;

        counter.textContent = `${checkedCount} / ${baseTotal} requirements met`;

        if (checkedCount === baseTotal && baseTotal > 0) {
          counter.style.color = 'green';
        } else {
          counter.style.color = '';
        }
      };

      checkboxes.forEach(cb => cb.addEventListener('change', updateCounter));
      updateCounter();
    });
  });
</script>

</body>
</html>
